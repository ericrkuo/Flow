<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: middleware.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: middleware.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
/**
 * Checks whether user is authenticated and authorized. If so, proceed with next(), otherwise redirect user to login page
 * Used as middle ware function
 * @param req - current incoming request
 * @param res - current response to request
 * @param next - handler for next fn
 * @returns {Promise&lt;T | void>|*|void|Response}
 */
function checkCredentials(req, res, next) {
    let main = req.app.locals.main;
    if (!isMainAndSpotifyApiAndRefreshCredentialValid) {
        req.app.locals.main = new Main();
        return res.redirect('/spotify/login');
    }

    return main.refreshCredentialService.checkCredentials()
        .then((result) => {
            if (result) return next();
            return res.redirect('/spotify/login');
        })
        .catch((err) => {
            console.log(err);
            throw err;
        })
}

/**
 * Tries refreshing the credentials if they are invalid.
 * Used as middle ware function
 * @param req - current incoming request
 * @param res - current response to request
 * @param next - handler for next fn
 * @returns {Promise&lt;T | void>|*|void|Response}
 */
function refreshCredentialsIfExpired(req, res, next) {
    let main = req.app.locals.main;
    if (!isMainAndSpotifyApiAndRefreshCredentialValid) {
        req.app.locals.main = new Main();
        return res.redirect('/spotify/login');
    }

    return main.refreshCredentialService.checkCredentials()
        .then((isValid) => {
            if (!isValid) {
                return main.refreshCredentialService.tryRefreshCredential();
            }
        })
        .then(() => {
            return next()
        })
        .catch((err) => {
            throw err;
        })
}

/**
 * Checks whether the instance Main, spotifyApi, and refreshCredentialService are valid
 * @param main - current instance of Main file
 * @returns boolean - returns true if main, spotify api, refresh credential service, and spotify tokens are defined
 */
function isMainAndSpotifyApiAndRefreshCredentialValid(main) {
    return main &amp;&amp; main.spotifyApi &amp;&amp; main.refreshCredentialService &amp;&amp; main.spotifyApi.getAccessToken() &amp;&amp; main.spotifyApi.getRefreshToken()
}

module.exports.checkCredentials = checkCredentials;
module.exports.refreshCredentialsIfExpired = refreshCredentialsIfExpired;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#checkCredentials">checkCredentials</a></li><li><a href="global.html#isMainAndSpotifyApiAndRefreshCredentialValid">isMainAndSpotifyApiAndRefreshCredentialValid</a></li><li><a href="global.html#refreshCredentialsIfExpired">refreshCredentialsIfExpired</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Thu Dec 24 2020 11:42:28 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
