<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: RefreshCredentialService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: RefreshCredentialService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Err = require("../constant/Error");
const {executeMethod} = require("./SpotifyApiWrapper");

class RefreshCredentialService {

    /**
     * Constructor for RefreshCredentialService
     * @param spotifyApi - current instance of spotifyApi
     */
    constructor(spotifyApi) {
        require('dotenv').config();
        this.spotifyApi = spotifyApi;
    }

    /**
     * Checks if credentials are valid and have not expired through a test call
     * @returns boolean - returns true if credentials are still valid
     */
    checkCredentials() {
        return executeMethod(() => {
            return this.spotifyApi.getArtist('2hazSY4Ef3aB9ATXW7F5w3')
        })
            .then((data) => {
                return true;
            })
            .catch((err) => {
                return false;
            })
    }

    /**
     * Checks credential and attempts to get a new access token with refresh token
     * @returns {Promise&lt;T | void>}
     */
    tryRefreshCredential() {
        return this.checkCredentials()
            .then((isValidCredential) => {
                if (!isValidCredential) {
                    return this.getNewAccessToken()
                        .then((accessToken) => {
                            this.spotifyApi.setAccessToken(accessToken);
                        });
                }
            })
            .catch((err) => {
                console.log("Error in getting new access token " + err);
                throw err;
            });
    }

    /**
     * Gets the new access token using refresh token by issuing a POST request to spotifyApi
     * @returns {Promise&lt;never>|Promise&lt;* | void>}
     */
    getNewAccessToken() {
        let refresh_token = this.spotifyApi.getRefreshToken();
        if (!refresh_token) {
            return Promise.reject(new Err.RefreshCredentialError("Refresh token is null or undefined"));
        }

        let axios = require('axios');
        let qs = require('querystring');
        let data = qs.stringify({
            grant_type: 'refresh_token',
            refresh_token: refresh_token,
        });

        let config = {
            method: 'post',
            url: 'https://accounts.spotify.com/api/token',
            headers: {
                'Authorization': 'Basic ' + Buffer.from(process.env.SPOTIFY_API_ID + ':' + process.env.SPOTIFY_CLIENT_SECRET).toString("base64"),
                'Content-type': "application/x-www-form-urlencoded",
            },
            data: data
        };

        return axios(config)
            .then((response) => {
                if (response &amp;&amp; response.data &amp;&amp; response.data["access_token"]) {
                    return response.data["access_token"];
                } else {
                    throw new Err.InvalidResponseError("Access token response from Spotify API is invalid");
                }
            })
            .catch((error) => {
                if (error.response &amp;&amp; error.response.data &amp;&amp; error.response.data) {
                    throw new Err.RefreshCredentialError(JSON.stringify(error.response.data));
                }
                throw error;
            });
    }
}

module.exports.RefreshCredentialService = RefreshCredentialService;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="RefreshCredentialService.html">RefreshCredentialService</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Thu Dec 24 2020 12:13:14 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
